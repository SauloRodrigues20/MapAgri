name: üèóÔ∏è Build APK Tradicional
on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-apk:
    name: Build APK
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üõ†Ô∏è Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        working-directory: MapAgriApp
        run: |
          npm install
          npm install -g @expo/cli eas-cli

      - name: üì± Create app.json
        working-directory: MapAgriApp
        run: |
          cat > app.json << 'EOF'
          {
            "expo": {
              "name": "MapAgri",
              "slug": "mapagri-agricultura",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "light",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#4CAF50"
              },
              "assetBundlePatterns": ["**/*"],
              "android": {
                "package": "com.mapagri.agricultura",
                "versionCode": 1,
                "compileSdkVersion": 34,
                "targetSdkVersion": 34,
                "buildToolsVersion": "34.0.0",
                "permissions": [
                  "ACCESS_FINE_LOCATION",
                  "ACCESS_COARSE_LOCATION", 
                  "CAMERA",
                  "WRITE_EXTERNAL_STORAGE",
                  "READ_EXTERNAL_STORAGE",
                  "INTERNET"
                ],
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#4CAF50"
                }
              },
              "plugins": [
                [
                  "expo-location",
                  {
                    "locationAlwaysAndWhenInUsePermission": "MapAgri precisa de GPS para marcar as coordenadas das amostras de solo."
                  }
                ],
                [
                  "expo-camera",
                  {
                    "cameraPermission": "MapAgri usa c√¢mera para fotografar as amostras de solo coletadas."
                  }
                ]
              ]
            }
          }
          EOF

      - name: üé® Create assets
        working-directory: MapAgriApp
        run: |
          mkdir -p assets
          
          # Criar √≠cone PNG simples 1024x1024 verde
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > assets/icon.png
          
          # Copiar para outros assets
          cp assets/icon.png assets/splash.png
          cp assets/icon.png assets/adaptive-icon.png
          cp assets/icon.png assets/favicon.png

      - name: ‚öôÔ∏è Initialize Project
        working-directory: MapAgriApp
        run: |
          # Inicializar projeto Expo se necess√°rio
          if [ ! -f "eas.json" ]; then
            echo "Initializing EAS project..."
            eas build:configure --platform android --non-interactive || true
          fi
          
          # Garantir que eas.json existe
          cat > eas.json << 'EOF'
          {
            "cli": {
              "version": ">= 5.8.0"
            },
            "build": {
              "production": {
                "android": {
                  "buildType": "apk"
                }
              }
            }
          }
          EOF

      - name: üèóÔ∏è Build APK com EAS
        working-directory: MapAgriApp
        run: |
          echo "üöÄ Starting EAS build..."
          
          # Start build and capture output
          BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive --wait 2>&1)
          echo "$BUILD_OUTPUT"
          
          # Try to extract APK URL from output
          APK_URL=$(echo "$BUILD_OUTPUT" | grep -o 'https://expo\.dev/artifacts/[^[:space:]]*\.apk' | head -1)
          
          if [ -n "$APK_URL" ]; then
            echo "üì• Downloading APK from: $APK_URL"
            curl -L "$APK_URL" -o MapAgri-v${GITHUB_REF_NAME#v}-release.apk
            
            # Verify APK was downloaded
            if [ -f "MapAgri-v${GITHUB_REF_NAME#v}-release.apk" ]; then
              echo "‚úÖ APK downloaded successfully"
              ls -la *.apk
            else
              echo "‚ùå Failed to download APK"
              exit 1
            fi
          else
            echo "‚ùå Could not extract APK URL from build output"
            echo "Trying alternative method..."
            
            # Fallback: get latest build
            eas build:list --platform android --limit 1 --json > build_info.json
            cat build_info.json
            
            BUILD_URL=$(jq -r '.[0].artifacts.buildUrl // empty' build_info.json 2>/dev/null || echo "")
            
            if [ -n "$BUILD_URL" ] && [ "$BUILD_URL" != "null" ]; then
              echo "üì• Downloading APK from build list: $BUILD_URL"
              curl -L "$BUILD_URL" -o MapAgri-v${GITHUB_REF_NAME#v}-release.apk
            else
              echo "‚ùå No APK URL found"
              exit 1
            fi
          fi

      - name: ‚úÖ Verify APK
        working-directory: MapAgriApp
        run: |
          APK_FILE="MapAgri-v${GITHUB_REF_NAME#v}-release.apk"
          
          if [ -f "$APK_FILE" ]; then
            APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
            echo "‚úÖ APK created successfully: $APK_SIZE"
            
            # Verificar se √© um APK v√°lido
            file "$APK_FILE"
            
            # Mover para local padr√£o tamb√©m
            cp "$APK_FILE" "MapAgri-release.apk"
          else
            echo "‚ùå APK not found: $APK_FILE"
            echo "Files in directory:"
            ls -la
            exit 1
          fi

      - name: üì§ Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            MapAgriApp/MapAgri-v${{ github.ref_name }}-release.apk
            MapAgriApp/MapAgri-release.apk
          name: üåæ MapAgri ${{ github.ref_name }}
          body: |
            # üì± MapAgri ${{ github.ref_name }} - APK Tradicional
            
            ## üéâ APK Pronto para Instalar!
            
            ### üì• Download:
            - **MapAgri-v${{ github.ref_name }}-release.apk** - APK tradicional para Android
            
            ### üì± Como Instalar:
            1. **Baixar** o APK no celular Android
            2. **Permitir** "Fontes desconhecidas" nas configura√ß√µes
            3. **Tocar** no arquivo APK baixado
            4. **Seguir** instru√ß√µes na tela
            5. **Usar** para coleta de amostras de solo!
            
            ### ‚ú® Funcionalidades:
            - üó∫Ô∏è GPS de alta precis√£o (< 10m)
            - üåæ 10 tipos de solo classificados  
            - üì∏ Upload autom√°tico de fotos
            - üìÇ Import/Export KML (Google Earth)
            - ‚òÅÔ∏è Sincroniza√ß√£o Supabase
            - üì± Funciona 100% offline
            
            ### üîß Compatibilidade:
            - **Android**: 5.0+ (API 21+)
            - **RAM**: 2GB m√≠nimo
            - **Storage**: 100MB livres
            - **GPS**: Obrigat√≥rio
            - **C√¢mera**: Recomendada
            
            ---
            **üáßüá∑ Desenvolvido para a agricultura brasileira**
          draft: false
          prerelease: false

      - name: üìä Build Summary
        run: |
          echo "## üéâ APK Build Completed!" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Android APK" >> $GITHUB_STEP_SUMMARY  
          echo "- **Version**: 1.0.0" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $(du -h MapAgriApp/MapAgri-v*.apk 2>/dev/null | cut -f1 | head -1 || echo 'Unknown')" >> $GITHUB_STEP_SUMMARY
          echo "- **Download**: [Release Page](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY