name: üèóÔ∏è Build APK Tradicional
on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-apk:
    name: Build APK
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üõ†Ô∏è Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        working-directory: MapAgriApp
        run: npm install

      - name: üì± Create app.json
        working-directory: MapAgriApp
        run: |
          cat > app.json << 'EOF'
          {
            "expo": {
              "name": "MapAgri",
              "slug": "mapagri-agricultura",
              "version": "1.0.0",
              "orientation": "portrait",
              "icon": "./assets/icon.png",
              "userInterfaceStyle": "light",
              "splash": {
                "image": "./assets/splash.png",
                "resizeMode": "contain",
                "backgroundColor": "#4CAF50"
              },
              "assetBundlePatterns": ["**/*"],
              "android": {
                "package": "com.mapagri.agricultura",
                "versionCode": 1,
                "compileSdkVersion": 34,
                "targetSdkVersion": 34,
                "buildToolsVersion": "34.0.0",
                "permissions": [
                  "ACCESS_FINE_LOCATION",
                  "ACCESS_COARSE_LOCATION", 
                  "CAMERA",
                  "WRITE_EXTERNAL_STORAGE",
                  "READ_EXTERNAL_STORAGE",
                  "INTERNET"
                ],
                "adaptiveIcon": {
                  "foregroundImage": "./assets/adaptive-icon.png",
                  "backgroundColor": "#4CAF50"
                }
              },
              "plugins": [
                [
                  "expo-location",
                  {
                    "locationAlwaysAndWhenInUsePermission": "MapAgri precisa de GPS para marcar as coordenadas das amostras de solo."
                  }
                ],
                [
                  "expo-camera",
                  {
                    "cameraPermission": "MapAgri usa c√¢mera para fotografar as amostras de solo coletadas."
                  }
                ]
              ]
            }
          }
          EOF

      - name: üé® Create assets
        working-directory: MapAgriApp
        run: |
          mkdir -p assets
          
          # Criar √≠cone PNG simples 1024x1024 verde
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > assets/icon.png
          
          # Copiar para outros assets
          cp assets/icon.png assets/splash.png
          cp assets/icon.png assets/adaptive-icon.png
          cp assets/icon.png assets/favicon.png

      - name: ‚öôÔ∏è Configure EAS
        working-directory: MapAgriApp
        run: |
          cat > eas.json << 'EOF'
          {
            "cli": {
              "version": ">= 5.8.0"
            },
            "build": {
              "production": {
                "android": {
                  "buildType": "apk",
                  "gradleCommand": ":app:assembleRelease"
                }
              },
              "preview": {
                "android": {
                  "buildType": "apk"
                }
              }
            }
          }
          EOF

      - name: üèóÔ∏è Build APK
        working-directory: MapAgriApp
        run: |
          echo "Starting EAS build..."
          eas build --platform android --profile production --non-interactive

      - name: üì• Download APK
        working-directory: MapAgriApp
        run: |
          echo "Getting latest build info..."
          BUILD_INFO=$(eas build:list --platform=android --status=finished --limit=1 --json)
          echo "Build info: $BUILD_INFO"
          
          BUILD_URL=$(echo "$BUILD_INFO" | jq -r '.[0].artifacts.buildUrl // empty')
          
          if [ -n "$BUILD_URL" ] && [ "$BUILD_URL" != "null" ]; then
            echo "Downloading APK from: $BUILD_URL"
            curl -L "$BUILD_URL" -o MapAgri-v1.0.0-release.apk
            ls -la *.apk || echo "No APK files found"
          else
            echo "No APK URL found in build artifacts"
            echo "Available builds:"
            eas build:list --platform=android --limit=5
            exit 1
          fi

      - name: ‚úÖ Verify APK
        working-directory: MapAgriApp
        run: |
          if [ -f "MapAgri-v1.0.0-release.apk" ]; then
            APK_SIZE=$(du -h MapAgri-v1.0.0-release.apk | cut -f1)
            echo "‚úÖ APK created successfully: $APK_SIZE"
            
            # Verificar se √© um APK v√°lido
            file MapAgri-v1.0.0-release.apk
          else
            echo "‚ùå APK not found!"
            exit 1
          fi

      - name: üì§ Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            MapAgriApp/MapAgri-v1.0.0-release.apk
          name: üåæ MapAgri ${{ github.ref_name }}
          body: |
            # üì± MapAgri ${{ github.ref_name }} - APK Tradicional
            
            ## üéâ APK Pronto para Instalar!
            
            ### üì• Download:
            - **MapAgri-v1.0.0-release.apk** - APK tradicional para Android
            
            ### üì± Como Instalar:
            1. **Baixar** o APK no celular Android
            2. **Permitir** "Fontes desconhecidas" nas configura√ß√µes
            3. **Tocar** no arquivo APK baixado
            4. **Seguir** instru√ß√µes na tela
            5. **Usar** para coleta de amostras de solo!
            
            ### ‚ú® Funcionalidades:
            - üó∫Ô∏è GPS de alta precis√£o (< 10m)
            - üåæ 10 tipos de solo classificados  
            - üì∏ Upload autom√°tico de fotos
            - üìÇ Import/Export KML (Google Earth)
            - ‚òÅÔ∏è Sincroniza√ß√£o Supabase
            - üì± Funciona 100% offline
            
            ### üîß Compatibilidade:
            - **Android**: 5.0+ (API 21+)
            - **RAM**: 2GB m√≠nimo
            - **Storage**: 100MB livres
            - **GPS**: Obrigat√≥rio
            - **C√¢mera**: Recomendada
            
            ---
            **üáßüá∑ Desenvolvido para a agricultura brasileira**
          draft: false
          prerelease: false

      - name: üìä Build Summary
        run: |
          echo "## üéâ APK Build Completed!" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Android APK" >> $GITHUB_STEP_SUMMARY  
          echo "- **Version**: 1.0.0" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: $(du -h MapAgriApp/MapAgri-v1.0.0-release.apk 2>/dev/null | cut -f1 || echo 'Unknown')" >> $GITHUB_STEP_SUMMARY
          echo "- **Download**: [Release Page](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY